<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹æŒ‘æˆ°è³½ - æœ€çµ‚é€£å‹•ç‰ˆ</title>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f4f8; padding-top: 30px; }
        .card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 400px; }
        #progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: #4caf50; transition: width 0.3s; }
        #equation { font-size: 44px; margin: 25px 0; color: #1a237e; font-weight: bold; min-height: 60px; }
        input[type="number"], .report-form input { font-size: 24px; width: 140px; text-align: center; padding: 10px; border: 2px solid #bbdefb; border-radius: 12px; outline: none; }
        .report-form input { width: 85%; font-size: 16px; margin: 5px 0; }
        button { padding: 12px 25px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; margin: 5px; }
        .btn-main { background: #3f51b5; color: white; width: 100%; margin-top: 20px; }
        #msg { margin-top: 15px; font-size: 18px; font-weight: bold; min-height: 24px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        
        <div id="info-panel" style="display:flex; justify-content: space-between; margin-bottom: 10px;">
            <span>é¡Œæ¬¡: <span id="current-count">0</span>/10</span>
            <span style="color:#2196f3;">â±ï¸: <span id="timer">0</span>s</span>
            <span style="color:#e91e63;">åˆ†æ•¸: <span id="total-score">0</span></span>
        </div>

        <div id="difficulty-area">
            <h2 style="color:#3f51b5;">æ•¸å­¸æŒ‘æˆ°è³½</h2>
            <p>æ‹¿æ»¿åˆ†å³å¯å›å ±è€å¸«å–”ï¼</p>
            <button style="background:#4caf50; color:white;" onclick="startGame(1)">ğŸŸ¢ å…¥é–€</button>
            <button style="background:#ff9800; color:white;" onclick="startGame(2)">ğŸŸ¡ é€²éš</button>
            <button style="background:#f44336; color:white;" onclick="startGame(3)">ğŸ”´ æŒ‘æˆ°</button>
        </div>

        <div id="game-area" style="display:none;">
            <div id="equation">è¼‰å…¥ä¸­...</div>
            <div>x = <input type="number" id="userAnswer" autocomplete="off" placeholder="?"></div>
            <button class="btn-main" onclick="checkAnswer()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <div id="msg"></div>
        </div>
    </div>

<script>
    let currentAnswer, score = 0, questionCount = 0, difficulty = 1;
    let timerSeconds = 0, timerInterval, isWaiting = false, generatedVCode = 0;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(f) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        o.start(); o.stop(audioCtx.currentTime + 0.15);
    }

    function startGame(lv) {
        difficulty = lv; score = 0; questionCount = 0; timerSeconds = 0;
        document.getElementById('difficulty-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        timerInterval = setInterval(() => { timerSeconds++; document.getElementById('timer').innerText = timerSeconds; }, 1000);
        nextQuestion();
    }

    function nextQuestion() {
        if (questionCount >= 10) { clearInterval(timerInterval); endGame(); return; }
        isWaiting = false; questionCount++;
        document.getElementById('current-count').innerText = questionCount;
        document.getElementById('progress-fill').style.width = (questionCount/10)*100 + "%";
        
        let x = Math.floor(Math.random() * 41) - 20; 
        let a, b, c, eqText;
        if (difficulty === 1) { a = 1; b = Math.floor(Math.random() * 21) - 10; c = x + b; eqText = `x ${b >= 0 ? '+ ' + b : '- ' + Math.abs(b)} = ${c}`; }
        else if (difficulty === 2) { a = Math.floor(Math.random() * 9) - 4 || 2; b = Math.floor(Math.random() * 21) - 10; c = a * x + b; let aDisp = (a === 1) ? "" : (a === -1 ? "-" : a); eqText = `${aDisp}x ${b >= 0 ? '+ ' + b : '- ' + Math.abs(b)} = ${c}`; }
        else { a = Math.floor(Math.random() * 5) + 6; let c_val = Math.floor(Math.random() * 4) + 1; let d = Math.floor(Math.random() * 21) - 10; b = (c_val * x + d) - (a * x); let aDisp = (a === 1) ? "" : (a === -1 ? "-" : a); let cDisp = (c_val === 1) ? "" : (c_val === -1 ? "-" : c_val); eqText = `${aDisp}x ${b >= 0 ? '+ ' + b : '- ' + Math.abs(b)} = ${cDisp}x ${d >= 0 ? '+ ' + d : '- ' + Math.abs(d)}`; }
        
        currentAnswer = x;
        document.getElementById('equation').innerText = eqText;
        document.getElementById('msg').innerText = "";
        document.getElementById('userAnswer').value = "";
        document.getElementById('userAnswer').focus();
    }

    function checkAnswer() {
        if (isWaiting) return;
        let val = parseInt(document.getElementById('userAnswer').value);
        if (isNaN(val)) return;
        isWaiting = true;
        if (val === currentAnswer) { playSound(880); score += 10; document.getElementById('total-score').innerText = score; document.getElementById('msg').innerHTML = "<span style='color:green'>ğŸŒŸ ç­”å°äº†ï¼</span>"; }
        else { playSound(220); document.getElementById('msg').innerHTML = `<span style='color:red'>âŒ æ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentAnswer}</span>`; }
        setTimeout(nextQuestion, 1200);
    }

    function endGame() {
        let isFullScore = (score === 100);
        let endHTML = `<h2>ç·´ç¿’çµæŸ</h2><p>å¾—åˆ†ï¼š${score}</p><p>è€—æ™‚ï¼š${timerSeconds} ç§’</p>`;
        if (isFullScore) {
            endHTML += `
                <div class="report-form" style="border: 2px solid #2196f3; background: #e3f2fd; padding:15px; border-radius:15px;">
                    <p style="color:#1a237e; font-weight:bold;">ğŸ† å…¨å°é”æˆï¼è«‹ç™»éŒ„ç´€éŒ„</p>
                    <input type="text" id="stuClass" placeholder="ç­ç´š (å¦‚:601)">
                    <input type="text" id="stuNo" placeholder="åº§è™Ÿ (å¦‚:05)" oninput="updateVCode(this.value)">
                    <input type="text" id="stuName" placeholder="å­¸ç”Ÿå§“å">
                    <div id="vcode-area" style="margin:10px 0; padding:10px; background:white; border-radius:10px; font-weight:bold; color:red; font-size:24px;">ğŸ”‘ é©—è­‰ç¢¼ï¼š--</div>
                    <input type="text" id="inputVCode" placeholder="è¼¸å…¥ä¸Šæ–¹ç´…å­—é©—è­‰ç¢¼">
                    <button style="background:#2196f3; color:white; width:100%;" onclick="submitToGoogle()">ç¢ºèªé€å‡ºæˆæœ</button>
                </div>`;
        } else {
            endHTML += `<button style="background:#4caf50; color:white;" onclick="location.reload()">é‡æ–°æŒ‘æˆ°</button>`;
        }
        document.getElementById('game-area').innerHTML = endHTML;
    }

    function updateVCode(noVal) {
        let no = parseInt(noVal);
        if (!isNaN(no)) {
            generatedVCode = (no * 3) * 100 + Math.floor(Math.random() * 90 + 10);
            document.getElementById('vcode-area').innerText = `ğŸ”‘ é©—è­‰ç¢¼ï¼š${generatedVCode}`;
        }
    }

    function submitToGoogle() {
        const sClass = document.getElementById('stuClass').value;
        const sNo = document.getElementById('stuNo').value;
        const sName = document.getElementById('stuName').value;
        const sVCode = document.getElementById('inputVCode').value;
        const now = new Date();
        const timeStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

        if(!sClass || !sNo || !sName || !sVCode) { alert("è«‹å¡«å¯«å®Œæ•´å–”ï¼"); return; }
        if(parseInt(sVCode) !== generatedVCode) { alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼"); return; }

        const formID = "1FAIpQLScmocoi5Eh46SX5k7eZc4wOY0FQrnbg_-YRinQP43tzYACaLA";
        const url = `https://docs.google.com/forms/d/e/${formID}/formResponse?` + 
                    `entry.31624889=${encodeURIComponent(sClass)}&` + 
                    `entry.291661577=${encodeURIComponent(sNo)}&` + 
                    `entry.1976426889=${encodeURIComponent(sName)}&` + 
                    `entry.1490605511=1&` + 
                    `entry.1411146026=${timerSeconds}&` + 
                    `entry.1027607786=${encodeURIComponent(timeStr)}&` + 
                    `entry.2124156766=${sVCode}&submit=Submit`;

        window.open(url, '_blank');
        alert("æˆæœå·²é€å‡ºï¼");
        location.reload();
    }
</script>
</body>
</html>